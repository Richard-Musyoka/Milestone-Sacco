@page "/profile"
@attribute [Authorize]
@using System.Security.Claims
@inject AuthenticationStateProvider AuthState
@inject NavigationManager Nav

<div class="profile-page">
    <div class="container py-4">
        <div class="card shadow-lg">
            <div class="profile-cover bg-primary-gradient"></div>
            <div class="card-body pt-0">
                <div class="text-center px-4 pb-4 position-relative">
                    <!-- Profile Avatar -->
                    <div class="avatar-container">
                        <img src="@GetAvatar(user)" class="avatar-xl rounded-circle shadow border border-4 border-white" />
                        <button class="btn btn-sm btn-light rounded-pill avatar-edit-btn">
                            <i class="bi bi-camera"></i>
                        </button>
                    </div>

                    <!-- User Info -->
                    <h3 class="mt-3 mb-1">@user.Identity.Name</h3>
                    <p class="text-muted mb-3">
                        <i class="bi bi-envelope me-1"></i> @user.FindFirst(ClaimTypes.Email)?.Value
                    </p>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-center gap-3 mb-4">
                        <button class="btn btn-primary btn-sm rounded-pill px-3" @onclick="GoToDashboard">
                            <i class="bi bi-speedometer2 me-1"></i> Dashboard
                        </button>
                        <button class="btn btn-outline-danger btn-sm rounded-pill px-3" @onclick="Logout">
                            <i class="bi bi-box-arrow-right me-1"></i> Logout
                        </button>
                    </div>

                    <!-- Quick Stats -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="stat-card bg-light p-3 rounded-3 text-center">
                                <div class="stat-icon text-primary mb-2">
                                    <i class="bi bi-person-badge fs-4"></i>
                                </div>
                                <div class="stat-label text-muted small">Member ID</div>
                                <div class="stat-value fw-bold">JKL-12345</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card bg-light p-3 rounded-3 text-center">
                                <div class="stat-icon text-success mb-2">
                                    <i class="bi bi-calendar-check fs-4"></i>
                                </div>
                                <div class="stat-label text-muted small">Joined</div>
                                <div class="stat-value fw-bold">Jan 5, 2023</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card bg-light p-3 rounded-3 text-center">
                                <div class="stat-icon text-warning mb-2">
                                    <i class="bi bi-coin fs-4"></i>
                                </div>
                                <div class="stat-label text-muted small">Shares</div>
                                <div class="stat-value fw-bold">KES 12,500</div>
                            </div>
                        </div>
                    </div>

                    <!-- About Section -->
                    <div class="profile-section mb-4">
                        <div class="section-header d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="bi bi-person-lines-fill text-primary me-2"></i>About Me
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary">Edit</button>
                        </div>
                        <div class="section-content bg-light p-3 rounded">
                            <p class="mb-0">
                                Enthusiastic SACCO member, passionate about saving and investment.
                                Actively participates in community financial literacy sessions.
                            </p>
                        </div>
                    </div>

                    <!-- Contact Info -->
                    <div class="profile-section mb-4">
                        <div class="section-header d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="bi bi-telephone text-primary me-2"></i>Contact Info
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary">Edit</button>
                        </div>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="contact-item bg-light p-3 rounded d-flex align-items-center">
                                    <div class="contact-icon bg-primary text-white rounded-circle me-3">
                                        <i class="bi bi-envelope-fill"></i>
                                    </div>
                                    <div>
                                        <div class="contact-label small text-muted">Email</div>
                                        <div>jane.doe@example.com</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="contact-item bg-light p-3 rounded d-flex align-items-center">
                                    <div class="contact-icon bg-success text-white rounded-circle me-3">
                                        <i class="bi bi-telephone-fill"></i>
                                    </div>
                                    <div>
                                        <div class="contact-label small text-muted">Phone</div>
                                        <div>+254 700 123456</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="contact-item bg-light p-3 rounded d-flex align-items-center">
                                    <div class="contact-icon bg-info text-white rounded-circle me-3">
                                        <i class="bi bi-geo-alt-fill"></i>
                                    </div>
                                    <div>
                                        <div class="contact-label small text-muted">Location</div>
                                        <div>Nairobi, Kenya</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="contact-item bg-light p-3 rounded d-flex align-items-center">
                                    <div class="contact-icon bg-warning text-white rounded-circle me-3">
                                        <i class="bi bi-shield-lock-fill"></i>
                                    </div>
                                    <div>
                                        <div class="contact-label small text-muted">ID Number</div>
                                        <div>12345678</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Social Links -->
                    <div class="profile-section mb-4">
                        <div class="section-header mb-3">
                            <h5 class="mb-0">
                                <i class="bi bi-people text-primary me-2"></i>Social Links
                            </h5>
                        </div>
                        <div class="d-flex justify-content-center gap-2">
                            <a href="#" class="social-btn btn btn-outline-primary rounded-circle">
                                <i class="bi bi-twitter"></i>
                            </a>
                            <a href="#" class="social-btn btn btn-outline-primary rounded-circle">
                                <i class="bi bi-linkedin"></i>
                            </a>
                            <a href="#" class="social-btn btn btn-outline-primary rounded-circle">
                                <i class="bi bi-facebook"></i>
                            </a>
                            <a href="#" class="social-btn btn btn-outline-primary rounded-circle">
                                <i class="bi bi-whatsapp"></i>
                            </a>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="profile-section mb-4">
                        <div class="section-header d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="bi bi-clock-history text-primary me-2"></i>Recent Activity
                            </h5>
                            <a href="#" class="btn btn-sm btn-outline-primary">View All</a>
                        </div>
                        <div class="activity-timeline">
                            <div class="timeline-item">
                                <div class="timeline-badge bg-success"></div>
                                <div class="timeline-content bg-light p-3 rounded">
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold">Deposit</span>
                                        <small class="text-muted">Jun 20, 2025</small>
                                    </div>
                                    <p class="mb-0">Saved KES 15,000 to your account</p>
                                </div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-badge bg-info"></div>
                                <div class="timeline-content bg-light p-3 rounded">
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold">Loan Payment</span>
                                        <small class="text-muted">Jun 15, 2025</small>
                                    </div>
                                    <p class="mb-0">Repaid loan installment of KES 5,200</p>
                                </div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-badge bg-warning"></div>
                                <div class="timeline-content bg-light p-3 rounded">
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold">Document Upload</span>
                                        <small class="text-muted">Jun 10, 2025</small>
                                    </div>
                                    <p class="mb-0">Submitted ID copy for verification</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Stats -->
                    <div class="profile-section">
                        <div class="section-header mb-3">
                            <h5 class="mb-0">
                                <i class="bi bi-bar-chart text-primary me-2"></i>Financial Progress
                            </h5>
                        </div>
                        <div class="progress-stats">
                            <div class="progress-item mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Savings Goal (KES 100,000)</span>
                                    <span>75%</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-success progress-bar-striped" style="width: 75%"></div>
                                </div>
                            </div>
                            <div class="progress-item mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Loan Repayment (KES 50,000)</span>
                                    <span>50%</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-info progress-bar-striped" style="width: 50%"></div>
                                </div>
                            </div>
                            <div class="progress-item">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Emergency Fund (KES 30,000)</span>
                                    <span>30%</span>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-warning progress-bar-striped" style="width: 30%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ClaimsPrincipal user;

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthState.GetAuthenticationStateAsync();
        user = auth.User;
    }

    private string GetAvatar(ClaimsPrincipal u)
    {
        var avatar = u.FindFirst("avatar")?.Value;
        return string.IsNullOrEmpty(avatar) ? "/images/default-avatar.png" : avatar;
    }

    private void GoToDashboard() => Nav.NavigateTo("/dashboard", true);

    private void Logout()
    {
        if (AuthState is CustomAuthStateProvider custom)
            custom.NotifyUserLogout();
        Nav.NavigateTo("/login", true);
    }
}